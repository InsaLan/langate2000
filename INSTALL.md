# How to install langate2000 on the gateway

## Preliminary steps

* You'll need to install python3, pip, virtualenv and Ipset :

    ```bash
    sudo apt install python3 python3-pip python3-virtualenv ipset
    ```

* Clone the langate2000 repository in the directory you want to install it :

    ```bash
    git clone https://github.com/Insalan-EquipeTechnique/insalan-langate2000.git
    ```
 
* Move to the created directory and launch the install script (basically it installs missing python dependancies and it generates the django secrets) :

     ```bash
     cd insalan-langate2000 && ./install.sh
     ```

## Installing and configuring nginx and gunicorn

* In order to deploy the langate2000 server in production, we need to install two things : **gunicorn**, a python WSGI server that generates the web pages based on the python code of the langate and **nginx**, the main web server that serves the webpages generated by the WSGI server and also the associated static assets :

    ```bash
    pip3 install gunicorn
    sudo apt install nginx
    ```

* Then, we will need to create a configuration file for nginx to be at the same time a reverse proxy in front of the gunicorn server and a static asset server. To do so, create a new file at `/etc/nginx/sites-enabled/portal` following the model below :

    ```nginx
    # Optional portal redirection http -> https
    server {
        listen 80 default_server;
        return 307 https://gate.insalan.fr/;
    }

    server {
        listen 443 ssl;
        server_name gate.insalan.fr;

        ssl on;

        # here goes all the ssl configuration (ssl certificate and private key location ...)

        # reverse proxy redirecting requests to the gunicorn WSGI server
        location / {
                gzip off;
		
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # used by the gate to know the IP of the clients on the LAN
                proxy_set_header Host gate.insalan.fr;
                proxy_pass http://127.0.0.1:8000; # gunicorn host and port, if you somehow changed those, you will need to edit this line
		
        }
	
        # static assets
        location /static/ {
                alias /var/www/html/static/; # this is the path where the static assets that the gate uses are stored, this path has to exist and you will need to use this exact same path for the STATIC_ROOT variable in the settings.py file 
        }

    }

    ```

## Editing the configuration files

* You'll need to create a `whitelist.json` file that contains the list of the MAC addresses of the devices that are allowed to access the internet without having to log on the langate (typically the servers). This file should be provided in the following format (note that the names are not important for the script, they are just here so that one can know the name of the device to which the given MAC is assigned) :

    ```json

	 [
		{
			"name": "shittyflute",
			"mac": "aa:bb:cc:dd:ee:ff"
		},

		{
			"name": "masterpiece",
			"mac": "aa:bb:cc:dd:ee:ff"
		},

		{                                 	
			"name": "julienlepers",
			"mac": "aa:bb:cc:dd:ee:ff"
		},

		...

	]

    ```

* Then, the langate/langate/settings.py needs to be modified according to your needs, here are the settings that you may need to tweak (by apparition order) :
	
	- `SERVER_IP` : the main IP of the server (on the management VLAN)
	- `STATIC_ROOT` : should point to the folder from where the static assets are served by the nginx server
	- `NETWORK` : you need to precisely modify the parameter `mark=(a,b)` of the Ipset object. The first element of the tuple (a) is the first mark number (for instance 100) and the second element of the tuple (b) is the number of marks (usually it's equal to your number of network exits/VPNs endpoints)
	- `LOGGING` : langate2000 generates 2 different log files : one containing django standard log messages and another with more langate specific logging information (creation/removal of users, logins/logouts from the gate, registration of devices on the internet...), you may want to modify the paths of these logs or the log level. See https://docs.djangoproject.com/en/2.1/topics/logging/ for more information.

* Finally, you'll probably to execute the following commands to create or update the database. Note that you will need to execute those commands each time you will change the code of one of the models.

    ```bash
    cd langate
    ./manage.py makemigrations
    ./manage.py migrate
    ```

## Ready, steady, go !

You can launch the gate using the langate.py script in the main folder.
To start the gate, simply run : `./langate.py start` and to stop it `./langate.py stop`.
This will take care of :
* Applying the iptables required by the gate (mangle & portal redirection).
* Creating the Ipset and adding the whitelisted devices.
* Launching gunicorn as a daemon.
